---
author: "Mohamed Abdalfttah"
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
  Sample: "Default!"
title: "Cell-Cell Communication in Space"
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width = "100%", fig.align='center', 
                      message = FALSE, warning = FALSE)
options(width = 1200)
```

# Load Libraries

```{r, warning=FALSE, message=FALSE}
## We load the required packages
library(stringr)
library(Seurat)
library(decoupleR)
# Only needed for data handling and plotting
library(dplyr)
library(tibble)
library(tidyr)
library(patchwork)
library(ggplot2)
library(ggplot2)
library(CellChat)
```

```{r}
generate_heatmap <- function(cellchat, signaling) {
  # Generate bubble plot data for the specified signaling pathway
  x <- netVisual_bubble(cellchat, sources.use = 6, targets.use = c(1:7), signaling = signaling, remove.isolate = FALSE, sort.by.source.priority = TRUE, return.data = TRUE)
  
  # Prepare the data for the heatmap
  heatmap_data <- x$communication %>%
    filter(!is.na(prob)) %>%
    select(interaction_name_2, source_target = source.target, prob) %>%
    spread(key = source_target, value = prob) %>%
    replace(is.na(.), 0)  # Replace NA in probability with 0
  
  # Set row names
  rows <- heatmap_data$interaction_name_2
  heatmap_data <- heatmap_data[,-1]
  heatmap_data <- as.data.frame(heatmap_data)
  rownames(heatmap_data) <- rows
  
  # Generate the heatmap
  pheatmap::pheatmap(as.matrix(heatmap_data),cluster_cols = F, cluster_rows = F,
                     #clustering_distance_rows = "euclidean",
                     #clustering_distance_cols = "euclidean",
                     #clustering_method = "complete",
                     #scale = "row",
                     #color = colorRampPalette(c("blue", "white", "red"))(50),
                     annotation_legend = TRUE)
}

```

```{r}
Sample <- params$Sample
```

```{r}
source(here::here("misc/paths.R"))
Sample = "ST.colon1"
```

# Read Files

```{r}
Data = "{fa_sp}/{robj_dir}/Topics_10_se_{Sample}.rds" %>%
  glue::glue() %>%
  here::here() %>%
    readRDS(.)
DefaultAssay(Data) = "SCT"
```

```{r}
Idents(Data) <- Data$SCT_snn_res.0.5
DimPlot(Data,cols = ggsci::pal_igv()(50))
SpatialDimPlot(Data, crop = F) + 
  guides(fill = guide_legend(override.aes = list(size=10))) + 
  scale_fill_manual(values = ggsci::pal_igv()(50))
```

```{r}
Data@meta.data <- Data@meta.data %>%
    dplyr::mutate(
        annotation_lvl1 = dplyr::case_when(
            SCT_snn_res.0.5 == 0 ~ "Unknown",
            SCT_snn_res.0.5 == 1 ~ "Tumor Area  1",
            SCT_snn_res.0.5 == 2 ~ "Tumor Area 2",
            SCT_snn_res.0.5 == 3 ~ "Normal-Epithelial",
            SCT_snn_res.0.5 == 4 ~ "Tumor Area 3",
            SCT_snn_res.0.5 == 5 ~ "TME",
            SCT_snn_res.0.5 == 6 ~ "Tumor Area 4",

            )
        )

```

```{r}
Idents(Data) <- Data$annotation_lvl1
DimPlot(Data, cols = ggsci::pal_igv()(50))
SpatialDimPlot(Data, crop = F) + 
  guides(fill = guide_legend(override.aes = list(size=10))) + 
  scale_fill_manual(values = ggsci::pal_igv()(50))
```

```{r}
# Prepare input data for CelChat analysis
data.input = Seurat::GetAssayData(Data, slot = "data", assay = "SCT") # normalized data matrix
meta = Data@meta.data

spatial.locs = Seurat::GetTissueCoordinates(Data, scale = NULL, cols = c("imagerow", "imagecol")) 

scale_path <- "{spaceranger}/Yingcheng_Wu/{Sample}/spatial" %>%
  glue::glue() %>%
  here::here()

scalefactors = jsonlite::fromJSON(txt = file.path(scale_path, 'scalefactors_json.json'))
spot.size = 65 # the theoretical spot size (um) in 10X Visium
conversion.factor = spot.size/scalefactors$spot_diameter_fullres
spatial.factors = data.frame(ratio = conversion.factor, tol = spot.size/2)
d.spatial <- CellChat::computeCellDistance(coordinates = spatial.locs, ratio = spatial.factors$ratio, tol = spatial.factors$tol)
min(d.spatial[d.spatial!=0]) # this value should approximately equal 100um for 10X Visium data
```

# Creat Cellchat Object
```{r}
cellchat <- createCellChat(object = data.input, meta = meta, group.by = "annotation_lvl1",
                           datatype = "spatial", coordinates = spatial.locs, spatial.factors = spatial.factors)
cellchat
```


```{r}
CellChatDB <- CellChatDB.human # use CellChatDB.human if running on human data
showDatabaseCategory(CellChatDB)
```

```{r}
# Show the structure of the database
dplyr::glimpse(CellChatDB$interaction)

# use a subset of CellChatDB for cell-cell communication analysis
CellChatDB.use <- subsetDB(CellChatDB, search = "Secreted Signaling", key = "annotation") # use Secreted Signaling

# set the used database in the object
cellchat@DB <- CellChatDB.use
```


```{r}
# subset the expression data of signaling genes for saving computation cost
cellchat <- subsetData(cellchat) # This step is necessary even if using the whole database
cellchat <- identifyOverExpressedGenes(cellchat)
cellchat <- identifyOverExpressedInteractions(cellchat, variable.both = F)
```

```{r}
ptm = Sys.time()

cellchat <- computeCommunProb(cellchat, type = "truncatedMean", trim = 0.1,
                              distance.use = TRUE, interaction.range = 250, scale.distance = 0.01,
                              contact.dependent = TRUE, contact.range = 100)
```

```{r}
cellchat <- filterCommunication(cellchat, min.cells = 10)
cellchat <- computeCommunProbPathway(cellchat)
cellchat <- aggregateNet(cellchat)
```

```{r}
"{cell_comm_sp}/{robj_dir}/{Sample}_cell_comm_obj.rds" %>%
    glue::glue() %>%
    here::here() %>%
    saveRDS(object = cellchat, file = .)
```

```{r}
cellchat <- "{cell_comm_sp}/{robj_dir}/{Sample}_cell_comm_obj.rds" %>%
    glue::glue() %>%
    here::here() %>%
    readRDS(file = .)

```

```{r}
groupSize <- as.numeric(table(cellchat@idents))
par(mfrow = c(1,2), xpd=TRUE)
netVisual_circle(cellchat@net$count, vertex.weight = rowSums(cellchat@net$count), weight.scale = T, label.edge= F, title.name = "Number of interactions")
netVisual_circle(cellchat@net$weight, vertex.weight = rowSums(cellchat@net$weight), weight.scale = T, label.edge= F, title.name = "Interaction weights/strength")
```


```{r}
netVisual_heatmap(cellchat, measure = "count", color.heatmap = "Blues")
netVisual_heatmap(cellchat, measure = "weight", color.heatmap = "Blues")
```

```{r}
#Compute the network centrality scores
cellchat <- netAnalysis_computeCentrality(cellchat, slot.name = "netP") # the slot 'netP' means the inferred intercellular communication network of signaling pathways
```

```{r}
netAnalysis_signalingRole_scatter(cellchat)
netAnalysis_signalingRole_scatter(cellchat, signaling = c("HH", "CCL", "PARs", "GDF", "EDN"))
```

```{r, fig.width=10}
# Get unique pathway names
unique_pathways <- cellchat@netP$pathways

# Loop through each pathway and generate visualizations
for (pathway in unique_pathways) {
  pathways.show <- c(pathway)
  
  # Spatial plot
  par(mfrow=c(1,1), xpd = TRUE) # `xpd = TRUE` should be added to show the title

  netVisual_aggregate(cellchat, signaling = pathways.show, layout = "circle")

}

```

```{r}
# Get unique pathway names
unique_pathways <- cellchat@netP$pathways

# Loop through each pathway and generate visualizations
for (pathway in unique_pathways) {
  pathways.show <- c(pathway)
  
  # Spatial plot
  par(mfrow = c(1, 1))
  p = netVisual_aggregate(cellchat, signaling = pathways.show, layout = "spatial",
                      edge.width.max = 2, vertex.size.max = 1, alpha.image = 0.2,
                      vertex.label.cex = 3.5)
  print(p)
}
```


#df.net$prob.original <- df.net$prob
#df.net$prob <- -1/log(df.net$prob)

# Protease-Activated Receptors (PARs) 

Protease-Activated Receptors (PARs) signaling pathway is an important communication mechanism in various physiological and pathological processes, including cancer. PARs are a family of G-protein coupled receptors (GPCRs) activated by proteolytic cleavage. The PAR family consists of four receptors: PAR1, PAR2, PAR3, and PAR4, encoded by the genes F2R, F2RL1, F2RL2, and F2RL3, respectively.

```{r}
# Example usage
generate_heatmap(cellchat, signaling = c("PARs"))
netVisual_aggregate(cellchat, signaling = "PARs", layout = "circle")
netVisual_aggregate(cellchat, signaling = "PARs", layout = "spatial",
                      edge.width.max = 2, vertex.size.max = 1, alpha.image = 0.2,
                      vertex.label.cex = 3.5)
SpatialFeaturePlot(Data, features = c("PRSS3", "F2R"), crop = F, max.cutoff = "q95", alpha = c(0,1))
```

# Growth Differentiation Factors

GDFs (Growth Differentiation Factors) are members of the TGF-β (Transforming Growth Factor-beta) superfamily, which are involved in various cellular processes, including growth, differentiation, and development. 

GDF Signaling: GDFs are crucial members of the TGF-β superfamily, playing significant roles in development, tissue homeostasis, and disease.

```{r}
# Example usage
generate_heatmap(cellchat, signaling = c("GDF"))
netVisual_aggregate(cellchat, signaling = "GDF", layout = "circle")
netVisual_aggregate(cellchat, signaling = "GDF", layout = "spatial",
                      edge.width.max = 2, vertex.size.max = 1, alpha.image = 0.2,
                      vertex.label.cex = 3.5)
```

```{r, fig.width=20, fig.height=20}
SpatialFeaturePlot(Data, features = c("GDF15", "GDF10", "GDF11", "TGFBR2", "TGFBR1", "ACVR2B"), crop = F, ncol = 4)
```


# Endothelin (EDN) 

EDN1 binding to EDNRB on cancer cells themselves (autocrine signaling) or on nearby stromal cells (paracrine signaling) can stimulate pathways that promote cell proliferation and survival. For example, the activation of the MAPK/ERK pathway can lead to increased cellular proliferation and resistance to apoptosis

Endothelial Cells: EDN1 binding to EDNRB on endothelial cells promotes angiogenesis—the formation of new blood vessels. This process is critical for providing the growing tumor with the necessary oxygen and nutrients.

Cancer-Associated Fibroblasts (CAFs): EDN1 can stimulate CAFs through EDNRB, leading to their activation.
```{r}
# Example usage
generate_heatmap(cellchat, signaling = c("EDN"))
netVisual_aggregate(cellchat, signaling = "EDN", layout = "circle")
netVisual_aggregate(cellchat, signaling = "EDN", layout = "spatial",
                      edge.width.max = 2, vertex.size.max = 1, alpha.image = 0.2,
                      vertex.label.cex = 3.5)
```

```{r, fig.width=10, fig.height=5}
SpatialFeaturePlot(Data, features = c("magic_EDN1", "magic_EDNRB"), crop = F, ncol =2,  max.cutoff = "q99", alpha = c(0,1))
VlnPlot(Data,"EDNRB", group.by = "annotation_lvl1", cols = ggsci::pal_igv()(50))
```

# CCL 

CCL15 is a chemokine produced by cancer cells that attracts CCR1-expressing myeloid cells to the tumor microenvironment.

Tumor-Associated Macrophages (TAMs): Once recruited, monocytes can differentiate into macrophages within the TME. These TAMs often adopt an immunosuppressive phenotype that supports tumor growth and metastasis.

Inflammatory Responses: CCR1 activation on myeloid cells can lead to the production of pro-inflammatory cytokines and other factors that can either promote or inhibit tumor progression, depending on the context.

Increased CCL15 expression promotes CRC cell proliferation and invasion via CCL15-CCR1 signaling.
```{r}
# Example usage
generate_heatmap(cellchat, signaling = c("CCL"))
netVisual_aggregate(cellchat, signaling = "CCL", layout = "circle")
netVisual_aggregate(cellchat, signaling = "CCL", layout = "spatial",
                      edge.width.max = 2, vertex.size.max = 1, alpha.image = 0.2,
                      vertex.label.cex = 3.5)
```

```{r, fig.width=20, fig.height=5}
SpatialFeaturePlot(Data, features = c("magic_CCR1", "magic_CXCL10"), crop = F, ncol =2, alpha = c(0,1))
```

# Hedgehog (HH) Signaling 

```{r}
generate_heatmap(cellchat, signaling = c("HH"))
netVisual_aggregate(cellchat, signaling = "HH", layout = "circle")
netVisual_aggregate(cellchat, signaling = "HH", layout = "spatial",
                      edge.width.max = 2, vertex.size.max = 1, alpha.image = 0.2,
                      vertex.label.cex = 3.5)
```

```{r, fig.width=20, fig.height=5}
SpatialFeaturePlot(Data, features = c("magic_IHH", "magic_PTCH1"), crop = F, ncol =2, max.cutoff = "q95", alpha = c(0,1))
```

# BRADYKININ

Bradykinin mediates signaling modules in various cells such as cardiomyocytes, epithelial cells, fibroblasts and neuroblastoma cells. In synovial fibroblasts, bradykinin stimulates B2R and activates IKKα/β (IKK alpha/beta) via the activation of PLC, PKC-δ (PRKCD) and increases the binding of RELA and NFKB1 to the NF-κB element, which leads to the increased production of IL-6 in rheumatoid arthritis 

Bradykinin promotes proliferation, migration, and invasion of cervical cancer cells through STAT3 signaling pathways
```{r}
generate_heatmap(cellchat, signaling = c("BRADYKININ"))
netVisual_aggregate(cellchat, signaling = "BRADYKININ", layout = "circle")
netVisual_aggregate(cellchat, signaling = "BRADYKININ", layout = "spatial",
                      edge.width.max = 2, vertex.size.max = 1, alpha.image = 0.2,
                      vertex.label.cex = 3.5)
```

```{r, fig.width=20, fig.height=5}
SpatialFeaturePlot(Data, features = c("KNG1", "BDKRB1", "BDKRB2"), crop = F, ncol =3)
```


```{r}
generate_heatmap(cellchat, signaling = c("SEMA3"))
netVisual_aggregate(cellchat, signaling = "SEMA3", layout = "circle")
netVisual_aggregate(cellchat, signaling = "SEMA3", layout = "spatial",
                      edge.width.max = 2, vertex.size.max = 1, alpha.image = 0.2,
                      vertex.label.cex = 3.5)
```

```{r}
netVisual_bubble(cellchat, sources.use = c(1:7), targets.use = c(1:7), signaling = "SEMA3", remove.isolate = FALSE, sort.by.source.priority = TRUE, return.data = TRUE)
```

```{r}
sessionInfo()
```

