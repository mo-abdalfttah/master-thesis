---
title: "QC"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
    df_print: paged
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width = "100%", fig.align='center', 
                      message = FALSE, warning = FALSE)
options(width = 1200)
```

## Introduction
This script is set to carry out QC visualization and filtering of Visium slides so as to prepare them for subsequent analysis.
We use as reference QC workflows the ones shown in:
* [Seurat](https://satijalab.org/seurat/articles/spatial_vignette.html)
* [Spaniel](https://bioconductor.org/packages/devel/bioc/vignettes/Spaniel/inst/doc/spaniel-vignette.html)

## Libraries

```{r}
library(Seurat)
# library(ggpubr)
library(cowplot)
library(dplyr)
library(ggplot2)
library(stringr)
library(readr)
library(glue)
library(here)
```

## Setting parameters
Loading necessary paths and parameters
```{r}
source(here::here("misc/paths.R"))
# source(here::here("utils/bin.R"))

"{qc_sp}/{plt_dir}" %>%
  glue::glue() %>%
  here::here() %>%
  dir.create(
    path = .,
    showWarnings = FALSE,
    recursive = TRUE)

"{qc_sp}/{robj_dir}" %>%
  glue::glue() %>%
  here::here() %>%
  dir.create(
    path = .,
    showWarnings = FALSE,
    recursive = TRUE)
```

## Load data
We have 4 different datasets that we are going to look at together here.

We start by using `STUtility` to look at how the number of features and counts look on capture area. Spots within the tissue region which have a low number of genes or counts may be due to experimental problems which should be addressed. Conversely spots which lie outside of the tissue and have a high number of counts or large number of genes may indicate that there is background contamination or that the image wasn't rotated properly when mapping the spots. .
```{r fig.height=10, fig.width=10}
gem_ls <- c("GSM6256810", "GSM6256811", "GSM6256812", "GSM6256813")
Author <- "Ombretta_Garbarino"
stutility_plts <- lapply(gem_ls, function(id) {
  
  sample_id <- c("GSM6256810", "GSM6256811", "GSM6256812", "GSM6256813")
  proj_dir <- here::here()
  spaceranger_data <- glue::glue("{spaceranger}/{Author}/{id}/") %>% here::here()
  
  # The recommended method to read the files into R is via the creation of a data.frame that we will call the infoTable.
  # There are four columns in this table that are required for Visium data: “samples”, “spotfiles”, “imgs” and “json”.
  # These columns specify the paths to the required input files. 
  infoTable <- data.frame(
    samples = glue::glue("{spaceranger_data}/filtered_feature_bc_matrix.h5"),
    spotfiles = glue::glue("{spaceranger_data}/tissue_positions_list.csv"),
    imgs = glue::glue("{spaceranger_data}/tissue_lowres_image.png"),
    json = glue::glue("{spaceranger_data}/scalefactors_json.json")
  )
  
  # Load data
  se <- STutility::InputFromTable(infoTable, disable.subset = TRUE)

  # Collect all genes coded on the mitochondrial genome
  mt.genes <- grep(pattern = "^MT-", x = rownames(se), value = TRUE)
  se$percent.mito <- 
    (Matrix::colSums(se@assays$RNA@counts[mt.genes, ]) / 
       Matrix::colSums(se@assays$RNA@counts)) * 100
  
  # Collect all genes coding for ribosomal proteins
  rp.genes <- grep(pattern = "^RPS|^RPL", x = rownames(se), value = TRUE)
  se$percent.ribo <- 
    (Matrix::colSums(se@assays$RNA@counts[rp.genes, ]) / 
       Matrix::colSums(se@assays$RNA@counts)) * 100
  
  se <- STutility::LoadImages(se, time.resolve = F, verbose = T)

  STutility::FeatureOverlay(
    se, 
    features = c("nFeature_RNA", "nCount_RNA",
                 "percent.ribo", "percent.mito"), 
    cols = c("lightgrey", "yellow", "orange", "red", "dark red"), 
    dark.theme = FALSE, 
    type = "raw",
    pt.alpha = 0.7,
    ncols = 2) +
    patchwork::plot_annotation(title = glue::glue("GEM ID - {id}\nSample ID - {sample_id}")) &
    ggplot2::coord_fixed(ratio = 1)

})

stutility_plts
gc()
```

Next we load the `Seurat` object
```{r}
sp_ls <- lapply(gem_ls, function(gem_id) {
  spaceranger_data <- glue::glue("{spaceranger}/{Author}/{gem_id}/")
  sample_id <- c("GSM6256810", "GSM6256811", "GSM6256812", "GSM6256813")

  
  se_obj <- Seurat::Load10X_Spatial(
    data.dir = here::here(spaceranger_data),
    filename = "filtered_feature_bc_matrix.h5",
    assay = "Spatial",
    slice = gem_id,
    filter.matrix = TRUE)
  se_obj[["gem_id"]] <- gem_id
  return(se_obj)
})

se_obj <- merge(sp_ls[[1]], y = sp_ls[2:length(sp_ls)],
                add.cell.ids = gem_ls,
                project = "Yingcheng_Wu")
```

Add mitochondrial and ribosomal %
```{r}
# Collect all genes coded on the mitochondrial genome
se_obj[["percent.mito"]] <- Seurat::PercentageFeatureSet(
  object = se_obj,
  pattern = "^MT-")
summary(se_obj[["percent.mito"]])

# Collect all genes coding for ribosomal proteins
se_obj[["percent.ribo"]] <- Seurat::PercentageFeatureSet(
  object = se_obj,
  pattern = "^RPS|^RPL")
summary(se_obj[["percent.ribo"]])
```

## QC Analysis

### Remove empty genes
We start by removing those genes that aren't expressed in any of the spots overlaying the tissue
```{r}
keep_genes <- rowSums(as.matrix(se_obj@assays$Spatial@counts)) != 0
table(keep_genes)
se_obj <- se_obj[keep_genes, ]
```

### Basic features
#### Number of genes
We start by plotting some basic features that will help us visualize and define filtering options.
We start by plotting the number of genes per spot, *complexity*, to assess if there are empty spots or huge disparity.

```{r fig.height=8, fig.width=12}
SCrafty::nfeature_hist_st(
  se = se_obj,
  nfeat = "nFeature_Spatial",
  sample_id = "gem_id")
```

After looking at the distribution we are also going to look at how these spots look on the tissue
```{r fig.height=12, fig.width=12}
lapply(gem_ls, function(gem_id) {
  print(gem_id)
  sample_id <- c("GSM6256810", "GSM6256811", "GSM6256812", "GSM6256813")
  
  Seurat::SpatialFeaturePlot(
    object = se_obj[, se_obj$gem_id == gem_id],
    features = "nFeature_Spatial",
    images = gem_id) +
    ggplot2::labs(title = gem_id) +
    ggplot2::theme(plot.title = element_text(hjust = 0.5, size = 18))
  
}) %>% cowplot::plot_grid(plotlist = .)
```

#### Number of reads
Next we want to look at the number of reads captured per spot, this should correlate with spot complexity and will allow us to see regions with higher transcriptional activity.
```{r fig.height=8, fig.width=12}
SCrafty::ncount_hist_st(
  se = se_obj,
  ncount = "nCount_Spatial",
  sample_id = "gem_id")
```

```{r fig.height=12, fig.width=12}
lapply(gem_ls, function(gem_id) {
  
  sample_id <- c("GSM6256810", "GSM6256811", "GSM6256812", "GSM6256813")
  
  Seurat::SpatialFeaturePlot(
    object = se_obj[, se_obj$gem_id == gem_id],
    features = "nCount_Spatial",
    images = gem_id) +
    ggplot2::labs(title = gem_id) +
    ggplot2::theme(plot.title = element_text(hjust = 0.5, size = 18))
  
}) %>% cowplot::plot_grid(plotlist = .)
```

#### Gene counts
Another characteristic we want to look at is how many counts per gene there are since we want to remove lowly expressed genes which aren't giving information but potentially introducing noise.
```{r fig.height=8, fig.width=12}
SCrafty::gene_count_hist(
  se = se_obj,
  slot = "counts",
  assay = "Spatial",
  sample_id = "gem_id")
```

#### Gene ubiquitousness
We also look at on how many spots each gene is detected, we see there are a few genes expressed in almost all the spots while and a majority of genes detected in few spots.
```{r fig.height=8, fig.width=12, eval=FALSE}
count_mtrx <- Seurat::GetAssayData(
  object = se_obj,
  slot = "counts",
  assay = "Spatial")

gene_attr <- lapply(gem_ls, function(gem_id) {
  mask <- stringr::str_detect(
    string = colnames(count_mtrx),
    pattern = gem_id)
  
  gene_attr <- data.frame(
    nUMI = Matrix::rowSums(count_mtrx[, mask]), 
    nSpots = Matrix::rowSums(count_mtrx[, mask] > 0),
    gem_id = gem_id,
    sample_id = id_sp_df[id_sp_df$gem_id == gem_id, ] %>% dplyr::pull(donor_id))
}) %>%
  dplyr::bind_rows()

p4 <- ggplot2::ggplot() +
  ggplot2::geom_histogram(
    data = gene_attr,
    ggplot2::aes(nSpots),
    fill = "red",
    alpha = 0.7,
    color = "red",
    bins = 50) +
  ggplot2::facet_wrap(. ~ gem_id, scales = "free") +
  ggplot2::ggtitle("Total spots per gene") +
  ggpubr::theme_pubr()

p4
```

#### Mitochondrial %
Next we take a look at the mitochondrial %; This metric can help us get a first glimpse of metabolic activity and/or necrotic regions - 10X explains [here](https://kb.10xgenomics.com/hc/en-us/articles/360001086611-Why-do-I-see-a-high-level-of-mitochondrial-gene-expression-)
```{r fig.height=8, fig.width=12}
SCrafty::mit_pct_hist_st(
  se = se_obj,
  mito_percent = "percent.mito",
  sample_id = "gem_id")
```

```{r fig.height=12, fig.width=12}
lapply(gem_ls, function(gem_id) {
  
  sample_id <- c("GSM6256810", "GSM6256811", "GSM6256812", "GSM6256813")
  
  Seurat::SpatialFeaturePlot(
    object = se_obj[, se_obj$gem_id == gem_id],
    features = "percent.mito",
    images = gem_id) +
    ggplot2::labs(title = gem_id) +
    ggplot2::theme(plot.title = element_text(hjust = 0.5, size = 18))
  
}) %>% cowplot::plot_grid(plotlist = .)
```

#### Ribosomal %
Lastly we look at the ribosomal % which gives us insight into which regions are the most transcriptomically active when looked side by side with the number of detected genes.
```{r fig.height=8, fig.width=12}
SCrafty::ribo_pct_hist_st(
  se = se_obj,
  ribo_percent = "percent.ribo",
  sample_id = "gem_id")
```

```{r fig.height=12, fig.width=12}
lapply(gem_ls, function(gem_id) {
  
  sample_id <- c("GSM6256810", "GSM6256811", "GSM6256812", "GSM6256813")
  
  Seurat::SpatialFeaturePlot(
    object = se_obj[, se_obj$gem_id == gem_id],
    features = "percent.ribo",
    images = gem_id) +
    ggplot2::labs(title = gem_id) +
    ggplot2::theme(plot.title = element_text(hjust = 0.5, size = 18))
  
}) %>% cowplot::plot_grid(plotlist = .)
```

### Feature covariation
Next we look at how these features covariate.
```{r echo=FALSE}
qc_covar_plots <- function(
    se,
    nfeat = "nFeature_Spatial",
    ncount = "nCount_Spatial",
    slot = "counts",
    assay = "Spatial",
    percent.mito = NULL,
    percent.ribo = NULL,
    facet = NULL) {
  ### se: Seurat object
  require(ggplot2)
  require(Seurat)
  require(ggpubr)
  
  ## Compute mito and ribo %
  count_mtrx <- Seurat::GetAssayData(object = se,
                                     slot = slot,
                                     assay = assay)
  
  # Collect all genes coded on the mitochondrial genome
  if (is.null(percent.mito)) {
    mt.genes <- grep(pattern = "^MT-",
                     x = rownames(count_mtrx),
                     value = TRUE,
                     ignore.case = TRUE)
    se_obj[["percent.mito"]] <- (Matrix::colSums(count_mtrx[mt.genes, ]) /
                                   Matrix::colSums(count_mtrx)) * 100
  } else {
    se_obj[["percent.mito"]] <- se_obj[[percent.mito]]
  }
  
  
  # Collect all genes coding for ribosomal proteins
  if (is.null(percent.ribo)) {
    rp.genes <- grep(pattern = "^RPL|^RPS",
                     x = rownames(count_mtrx),
                     value = TRUE,
                     ignore.case = TRUE)
    se_obj[["percent.ribo"]] <- (Matrix::colSums(count_mtrx[rp.genes, ]) /
                                   Matrix::colSums(count_mtrx)) * 100
  } else {
    se_obj[["percent.ribo"]] <- se_obj[[percent.ribo]]
  }
  
  p1 <- ggplot2::ggplot() +
    ggplot2::geom_point(data = se[[]], 
                        ggplot2::aes_string(x = ncount,
                                            y = nfeat,
                                            color = "percent.mito"),
                        alpha = 0.7) +
    scale_color_gradient(low = "yellow", high = "red", na.value = NA) +
    ggplot2::ggtitle("Library size vs Detected genes") +
    ggplot2::labs(x = "Library Size", y = "Unique UMIs") +
    ggpubr::theme_pubr()
  
  if (!is.null(facet)) {
    p1 <- p1 + ggplot2::facet_wrap(facet, scales = "free")
  }
  
  p2 <- ggplot2::ggplot() +
    ggplot2::geom_point(data = se[[]], 
                        ggplot2::aes_string(x = ncount,
                                            y = nfeat,
                                            color = "percent.ribo"),
                        alpha = 0.7) +
    ggplot2::scale_color_gradient(low = "yellow", high = "red", na.value = NA) +
    ggplot2::ggtitle("Library size vs Detected genes") +
    ggplot2::labs(x = "Library Size", y = "Unique UMIs") +
    ggpubr::theme_pubr()
  
  if (!is.null(facet)) {
    p2 <- p2 + ggplot2::facet_wrap(facet, scales = "free")
  }
  
  p3 <- ggplot2::ggplot() +
    ggplot2::geom_point(data = se_obj[[]], 
                        ggplot2::aes_string(x = "percent.mito",
                                            y = nfeat,
                                            color = ncount),
                        alpha = 0.7) +
    ggplot2::scale_color_gradient(low = "yellow", high = "red", na.value = NA) +
    ggplot2::ggtitle("Mitochondrial % per spot") +
    ggplot2::labs(x = "Mitochondrial % ", y = "Unique UMIs") +
    ggpubr::theme_pubr()
  
  if (!is.null(facet)) {
    p3 <- p3 + ggplot2::facet_wrap(facet, scales = "free")
  }
  
  p4 <- ggplot2::ggplot() +
    ggplot2::geom_point(data = se_obj[[]], 
                        ggplot2::aes(x = percent.mito,
                                     y = percent.ribo),
                        fill = "red",
                        alpha = 0.7,
                        color = "red") +
    ggplot2::ggtitle("Mitochondrial % per spot") +
    ggplot2::labs(x = "Mitochondrial % ", y = "Ribosomal %") +
    ggpubr::theme_pubr()
  
  if (!is.null(facet)) {
    p4 <- p4 + ggplot2::facet_wrap(facet, scales = "free")
  }
  
  return(list(p1, p2, p3, p4))
}

```

```{r fig.height=15, fig.width=15}
plt_covar_ls <- qc_covar_plots(
  se = se_obj,
  nfeat = "nFeature_Spatial",
  ncount = "nCount_Spatial",
  slot = "counts",
  assay = "Spatial",
  percent.mito = "percent.mito",
  percent.ribo = "percent.ribo",
  facet = "gem_id")

# cowplot::plot_grid(plotlist = plt_covar_ls, ncol = 2, align = "hv", axis = "trbl")
plt_covar_ls
```

### Remove spots

Check if there are any spots not overlapping tissue

```{r fig.width=12, fig.height=6}
lapply(gem_ls, function(i) {
  p <- Seurat::SpatialFeaturePlot(
    object = se_obj[, se_obj$gem_id == i],
    features = "nCount_Spatial",
    images = i,
    alpha = c(0, 1)) +
    Seurat::SpatialFeaturePlot(
      object = se_obj[, se_obj$gem_id == i],
      features = "nCount_Spatial",
      images = i,
      alpha = 1)
  p
})
```

```{r, eval=FALSE}
proj_dir <- here::here()
shiny_files = list.files(glue::glue("{proj_dir}/{qc_sp}/{robj_dir}"), pattern = "selection-shinyapp")

to_remove <- lapply(shiny_files, function(id) {
    proj_dir <- here::here()
    shiny_path <- glue::glue("{proj_dir}/{qc_sp}/{robj_dir}/{id}")
    Files = read.csv(shiny_path)
    })

to_remove = bind_rows(to_remove)
# Re include removed spots from n7bgf1_hlb8l4 sample
to_remove = filter(to_remove, !grepl("n7bgf1_hlb8l4", barcode))
to_remove = to_remove[!duplicated(to_remove$barcode),]
se_obj = se_obj[,!colnames(se_obj) %in% to_remove$barcode]
```

```{r fig.width=12, fig.height=6, eval=FALSE}
lapply(gem_ls, function(i) {
  p <- Seurat::SpatialFeaturePlot(
    object = se_obj[, se_obj$gem_id == i],
    features = "nCount_Spatial",
    images = i,
    alpha = c(0, 1)) +
    Seurat::SpatialFeaturePlot(
      object = se_obj[, se_obj$gem_id == i],
      features = "nCount_Spatial",
      images = i,
      alpha = 1)
  p
})
```

## Save RDS

Save the object to use downstream.
```{r}
lapply(gem_ls, function(id) {
  se_obj_sub <- se_obj[, se_obj$gem_id == id]
  # Remove other images
  se_obj_sub@images <- se_obj_sub@images[Seurat::Images(se_obj_sub) == id]
  
  "{qc_sp}/{robj_dir}/qc_se_{id}.rds" %>%
    glue::glue() %>%
    here::here() %>%
    saveRDS(object = se_obj_sub, file = .)
})
```

## Session Info

```{r}
sessionInfo()
```

